name: build-and-sign
run-name: Demo workflow signing with SignPath
on: 
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v3
      with:
        lfs: true

    - name: Debug â€“ list files
      run: |
        echo "Listing workspace"
        ls -R .

    - name: Upload unsigned artifact
      id: upload-unsigned-artifact
      uses: actions/upload-artifact@v4
      with:
        name: "unsigned"
        path: grepWin-2.1.12-x64.msi
        compression-level: 0   

    - name: Sign
      uses: signpath/github-action-submit-signing-request@v2
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
        project-slug: 'Pip.Int.Proj'
        signing-policy-slug: 'test-signing'
        local-file: './grepWin-2.1.12-x64.msi'
        github-artifact-id:  ${{steps.upload-unsigned-artifact.outputs.artifact-id}}
        wait-for-completion: true
        output-artifact-directory: 'signed'

    - name: Upload signed artifact
      uses: actions/upload-artifact@v4
      with:
        name: "signed"
        path: "signed"
