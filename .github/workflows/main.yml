name: build-and-sign
run-name: Demo workflow signing with SignPath
on: 
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build_and_sign:
    runs-on: windows-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    # If the MSI is already in the repo:
    - name: Upload unsigned artifact
      id: upload-unsigned-artifact
      uses: actions/upload-artifact@v4
      with:
        name: "Pip.Int.Proj"
        if-no-files-found: error
        path: |
          ./grepWin-2.1.12-x64.msi   # <<< FIXED

    - name: Sign with SignPath
      uses: signpath/github-action-submit-signing-request@v2
      env:
        SIGNPATH_SIGNING_POLICY_SLUG: |
          ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) 
              && 'release-signing' 
              || 'test-signing' }}
      with:
        api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
        organization-id: '${{ vars.SIGNPATH_ORGANIZATION_ID }}'
        project-slug: 'Pip.Int.Proj'
        signing-policy-slug:  '${{ env.SIGNPATH_SIGNING_POLICY_SLUG }}'
        github-artifact-id:  "${{steps.upload-unsigned-artifact.outputs.artifact-id}}"
        wait-for-completion: true
        output-artifact-directory: 'Pip.Int.Proj-signed'  # output folder

    - name: Upload signed artifact
      uses: actions/upload-artifact@v4
      with:
        name: "demo-application-signed"
        path: "Pip.Int.Proj-signed"   #
        if-no-files-found: error
